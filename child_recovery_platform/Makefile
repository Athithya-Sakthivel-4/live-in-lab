# Define Python environment paths
PYTHON = .venv/bin/python
PIP = .venv/bin/pip
UVICORN = .venv/bin/uvicorn

# Define app entry point
APP = app.py

# System dependencies (Linux & macOS)
SYSTEM_DEPENDENCIES = libgl1 libglib2.0-0 mesa-utils
MAC_DEPENDENCIES = opencv

# 1ï¸âƒ£ Run everything in one step
all: system-deps venv install-db run

# 2ï¸âƒ£ Install system dependencies automatically
system-deps:
	@echo "ğŸ” Detecting OS..."
	@if [ -f "/etc/debian_version" ]; then \
		echo "ğŸ“¦ Installing system dependencies for Debian-based OS"; \
		sudo apt-get update && sudo apt-get install -y $(SYSTEM_DEPENDENCIES); \
	elif [ "$$(uname)" = "Darwin" ]; then \
		echo "ğŸ Installing dependencies for macOS"; \
		brew install $(MAC_DEPENDENCIES); \
	else \
		echo "âš ï¸ Unsupported OS. Please install dependencies manually."; \
		exit 1; \
	fi

# 3ï¸âƒ£ Set up virtual environment
venv:
	@echo "ğŸ› ï¸ Setting up virtual environment..."
	rm -rf .venv  # Ensure fresh environment
	python3 -m venv .venv
	. .venv/bin/activate && $(PIP) install --upgrade pip setuptools wheel


# 4ï¸âƒ£ Install Python dependencies
install:
	@echo "ğŸ“¦ Installing Python dependencies..."
	$(PIP) install --no-cache-dir -r requirements.txt
	$(PIP) cache purge  # Clean cache

# 5ï¸âƒ£ Initialize database (after installing dependencies)
install-db: install
	@echo "ğŸ—‚ï¸ Setting up database..."
	$(PYTHON) database.py

# 6ï¸âƒ£ Run the FastAPI application with Uvicorn
run:
	@echo "ğŸš€ Starting FastAPI server..."
	$(UVICORN) app:app --host 0.0.0.0 --port 8000 --reload

# 7ï¸âƒ£ Clean up the environment
clean:
	@echo "ğŸ§¹ Cleaning up environment..."
	rm -rf .venv __pycache__ *.pyc *.pyo children.db
